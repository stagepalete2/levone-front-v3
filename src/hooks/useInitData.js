import { useCallback, useState, useEffect } from 'react'

import { useActiveQuest, useBranch, useCatalog, useCatalogCooldown, useCompany, useEmployee, useGameCooldown, useGroup, useInventory, useInventoryCooldown, useLogo, useParams, useQuest, useQuestCooldown, useSuperPrize, usePromotions } from '../zustand'

import getActiveQuest from '../api/endpoints/get/activequest.api'
import getBranch from '../api/endpoints/get/branch.api'
import getCatalog from '../api/endpoints/get/catalog.api'
import getCatalogCooldown from '../api/endpoints/get/catalog.cooldown.api'
import getCompany from '../api/endpoints/get/company.api'
import getGameCooldown from '../api/endpoints/get/game.cooldown.api'
import getInventory from '../api/endpoints/get/inventory.api'
import getInventoryCooldown from '../api/endpoints/get/inventory.cooldown.api'
import getQuest from '../api/endpoints/get/quest.api'
import getQuestCooldown from '../api/endpoints/get/quest.cooldown.api'
import getSuperPrize from '../api/endpoints/get/superprize.api'
import getPromotions from '../api/endpoints/get/promotions.api'
import getEmployees from '../api/endpoints/get/employees.api'

import patchClient from '../api/endpoints/patch/updateclient.api'
import { useCheckIsJoinedCommunity } from '../api/handlers/client/useCheckIsJoinedCommunity.handler'
import useClientHandler from '../api/handlers/client/useClient.handler'
import useInitParams from './useInitParams'

const useInitData = () => {
	const [isLoading, setIsLoading] = useState(true)
	const [isParamsLoaded, setIsParamsLoaded] = useState(false)
	const [isInviteLink, setIsInviteLink] = useState(false)
	const [isEmployee, setIsEmployee] = useState(false)

	// Params & Handlers
	const { company, branch, table, is_referral, delivery, from } = useInitParams()
	const { getClient } = useClientHandler()
	const { checkIsJoinedCommunity } = useCheckIsJoinedCommunity()

	// Zustand Setters
	const setCompany = useCompany((state) => state.setCompany)
	const setBranch = useBranch((state) => state.setBranch)
	const setCatalog = useCatalog((state) => state.setCatalog)
	const setInventory = useInventory((state) => state.setInventory)
	const setSuperPrize = useSuperPrize((state) => state.setSuperPrize)
	const setQuests = useQuest((state) => state.setQuests)
	const setActiveQuest = useActiveQuest((state) => state.setActiveQuest)
	const setGroup = useGroup((state) => state.setGroup)
	const setLogo = useLogo((state) => state.setLogo)
	const setEmployees = useEmployee((state) => state.setEmployees)
	const setPromotions = usePromotions((state) => state.setPromotions)

	const setCatalogCooldown = useCatalogCooldown((state) => state.setCatalogCooldown)
	const setInventoryCooldown = useInventoryCooldown((state) => state.setInventoryCooldown)
	const setQuestCooldown = useQuestCooldown((state) => state.setQuestCooldown)
	const setGameCooldown = useGameCooldown((state) => state.setGameCooldown)

	const setTableId = useParams((state) => state.setTable)
	const setCompanyId = useParams((state) => state.setCompany)
	const setBranchId = useParams((state) => state.setBranch)
	const setDelivery = useParams((state) => state.setDelivery)

	useEffect(() => {
		// Если флагов доставки и рефералки больше нет, но экран блокировки висит — убираем его
		if (!delivery && !is_referral && isInviteLink) {
			setIsInviteLink(false)
		}
	}, [delivery, is_referral, isInviteLink])

	const loadData = useCallback(async () => {
		if (!company || !branch) {
			setIsLoading(false)
			return
		}

		setIsLoading(true)

		try {
			// 1. Получаем Компанию
			const companyResponse = await getCompany({ company: company })
			if (!companyResponse?.company_id) {
				throw new Error("Company not found")
			}

			// Устанавливаем данные компании
			setCompany(companyResponse.domain)
			setLogo({
				logotype: companyResponse.images?.logotype_image,
				coin: companyResponse.images?.coin_image,
				card: companyResponse.images?.card_image
			})
			setGroup({
				group_name: companyResponse.group_name,
				group_id: companyResponse.group_id
			})
			setCompanyId(company)
			setBranchId(branch)
			setTableId(table)
			setDelivery(Boolean(delivery))

			// 2. Получаем Клиента
			const client = await getClient({ branch })
			if (!client?.id) {
				throw new Error("Client creation failed")
			}

			// 3. Получаем Филиал
			const branchResponse = await getBranch({ branch: branch })
			if (!branchResponse?.id) {
				throw new Error("Branch not found")
			}

			setBranch({
				id: branchResponse.id,
				name: branchResponse.name,
				yandex_map: branchResponse.yandex_map,
				gis_map: branchResponse.gis_map,
				story: branchResponse.story,
				logotype_image: branchResponse.logotype_image,
				coin_image: branchResponse.coin_image
			})

			// 4. Логика Рефералов и Доставки (ВАЖНО: не делаем return, чтобы данные грузились дальше)
			if (is_referral && from) {
				await patchClient({
					vk_user_id: client.vk_user_id,
					branch_id: branch,
					is_reffered: Boolean(is_referral),
					invited_by: from
				})
				setIsInviteLink(true)
			}

			if (delivery) {
				setIsInviteLink(true)
			}

			// 5. Проверка сообщества
			// Не блокируем выполнение, если проверка упадет (можно обернуть в try/catch или оставить так)
			await checkIsJoinedCommunity({
				vk_user_id: client.vk_user_id,
				branch: branch,
				group_id: companyResponse.group_id
			})

			// 6. Загрузка основных данных (параллельно)
			const [
				catalogResponse,
				inventoryResponse,
				superPrizeResponse,
				questResponse,
				activeQuestResponse,
				catalogCooldownResponse,
				inventoryCooldownResponse,
				questCooldownResponse,
				gameCooldownResponse,
				employeesResponse,
				promotionsResponse
			] = await Promise.all([
				getCatalog({ branch }),
				getInventory({ branch, vk_user_id: client.vk_user_id }),
				getSuperPrize({ branch, vk_user_id: client.vk_user_id }),
				getQuest({ branch, vk_user_id: client.vk_user_id }),
				getActiveQuest({ branch, vk_user_id: client.vk_user_id }),
				getCatalogCooldown({ branch, vk_user_id: client.vk_user_id }),
				getInventoryCooldown({ branch, vk_user_id: client.vk_user_id }),
				getQuestCooldown({ branch, vk_user_id: client.vk_user_id }),
				getGameCooldown({ branch, vk_user_id: client.vk_user_id }),
				getEmployees({ branch }),
				getPromotions({ branch })
			])

			// 7. Сохранение данных в Zustand
			if (catalogResponse) setCatalog(catalogResponse);
			if (inventoryResponse) setInventory(inventoryResponse);
			if (superPrizeResponse) setSuperPrize(superPrizeResponse);
			if (questResponse) setQuests(questResponse);
			if (activeQuestResponse) setActiveQuest(activeQuestResponse);
			if (catalogCooldownResponse) setCatalogCooldown(catalogCooldownResponse);
			if (inventoryCooldownResponse) setInventoryCooldown(inventoryCooldownResponse);
			if (questCooldownResponse) setQuestCooldown(questCooldownResponse);
			if (gameCooldownResponse) setGameCooldown(gameCooldownResponse);
			if (employeesResponse) setEmployees(employeesResponse)
			if (promotionsResponse) setPromotions(promotionsResponse)

			// 8. Проверка сотрудника
			if (employeesResponse) {
				const isUserEmployee = employeesResponse.some(
					(employee) => employee.vk_user_id === client.vk_user_id
				);
				setIsEmployee(isUserEmployee);
			}

			// Успех!
			setIsParamsLoaded(true)

		} catch (error) {
			console.error("Critical Init Error:", error)
			setIsParamsLoaded(false)
		} finally {
			setIsLoading(false)
		}
	}, [
		// Зависимости (оставил как есть, но по-хорошему их можно сократить, если линтер позволяет)
		company, branch, table, is_referral, from, delivery,
		setCompany, setGroup, setBranch, setTableId, setCompanyId, setBranchId,
		setCatalog, setInventory, setSuperPrize, setQuests, setActiveQuest,
		setCatalogCooldown, setInventoryCooldown, setQuestCooldown, setGameCooldown,
		setEmployees, setPromotions, setLogo, setDelivery,
		getClient, checkIsJoinedCommunity
	])

	return { isLoading, isParamsLoaded, isInviteLink, isEmployee, loadData }
}

export default useInitData